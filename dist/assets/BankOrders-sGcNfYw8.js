import{j as e}from"./query-D2a9LsAW.js";import{r as n}from"./vendor-Ba6jih-_.js";import{s as u}from"./index-DdeQrtE8.js";import{e as de}from"./exportToCsv-CTUkvpR5.js";import{D as me}from"./DataTable-Dzg2kqPW.js";import{M as O}from"./Modal-BazkrsRl.js";import{S as _}from"./StatCard-R_-DmWX7.js";import{u as ue,t as xe,o as he,s as m,n as pe}from"./types-Vcb-PP2J.js";import{V as p}from"./index-v3sBR1NV.js";import{w as S,ab as L,ak as M,aI as I,D as be,S as ge,aa as fe,at as R,X as Y,ao as je,aw as ye}from"./ui-yrixFDMZ.js";import"./router-PzPojOO1.js";import"./supabase-B5p9Wfie.js";const Ne=he({beneficiary_id:m().min(1,"İhtiyaç sahibi seçiniz"),aid_record_id:m().min(1,"Yardım kaydı seçiniz"),amount:pe().min(1,"Tutar giriniz"),bank_name:m().min(1,"Banka adı giriniz"),account_number:m().min(1,"Hesap numarası giriniz"),account_holder:m().min(1,"Hesap sahibi giriniz"),iban:m().min(26,"Geçerli IBAN giriniz").max(34),notes:m().optional()});function Oe(){const[B,F]=n.useState([]),[b,G]=n.useState({totalPending:0,totalSent:0,totalCompleted:0,totalAmount:0}),[H,q]=n.useState(!0),[c,P]=n.useState(""),[g,$]=n.useState("all"),[f,Q]=n.useState("all"),[V,x]=n.useState(!1),[K,h]=n.useState(!1),[j,A]=n.useState([]),[X,J]=n.useState([]),[U,W]=n.useState([]),{register:o,handleSubmit:Z,formState:{errors:r},reset:ee,watch:ae}=ue({resolver:xe(Ne)}),y=ae("beneficiary_id");n.useEffect(()=>{C(),T(),te()},[]),n.useEffect(()=>{y&&se(y)},[y]);const C=async()=>{try{const{data:a,error:t}=await u.from("payments").select(`
          *,
          beneficiaries (
            name,
            surname,
            phone,
            category
          ),
          aid_records (
            aid_type,
            amount,
            notes
          )
        `).eq("payment_method","bank_transfer").order("created_at",{ascending:!1});if(t)throw t;F(a||[])}catch(a){console.error("Banka emirleri yüklenirken hata:",a),p.error("Banka emirleri yüklenirken hata oluştu")}finally{q(!1)}},T=async()=>{try{const{data:a}=await u.from("payments").select("status, amount").eq("payment_method","bank_transfer");if(a){const t=a.filter(i=>i.status==="pending").length,s=a.filter(i=>i.status==="sent").length,l=a.filter(i=>i.status==="completed").length,d=a.reduce((i,k)=>i+(k.amount||0),0);G({totalPending:t,totalSent:s,totalCompleted:l,totalAmount:d})}}catch(a){console.error("İstatistikler yüklenirken hata:",a)}},te=async()=>{try{const{data:a,error:t}=await u.from("beneficiaries").select("id, name, surname, category").eq("status","active").order("name");if(t)throw t;J(a||[])}catch(a){console.error("İhtiyaç sahipleri yüklenirken hata:",{message:a instanceof Error?a.message:String(a),stack:a instanceof Error?a.stack:void 0})}},se=async a=>{try{const{data:t,error:s}=await u.from("aid_records").select("id, aid_type, amount, notes").eq("beneficiary_id",a).eq("status","approved").order("created_at",{ascending:!1});if(s)throw s;W(t||[])}catch(t){console.error("Yardım kayıtları yüklenirken hata:",t)}},D=n.useMemo(()=>B.filter(a=>{var d,i,k;const t=c===""||`${(d=a.beneficiaries)==null?void 0:d.name} ${(i=a.beneficiaries)==null?void 0:i.surname}`.toLowerCase().includes(c.toLowerCase())||a.account_holder.toLowerCase().includes(c.toLowerCase())||a.bank_name.toLowerCase().includes(c.toLowerCase())||((k=a.transaction_ref)==null?void 0:k.toLowerCase().includes(c.toLowerCase())),s=g==="all"||a.status===g;let l=!0;if(f!=="all"){const v=new Date(a.order_date),w=new Date;switch(f){case"today":{l=v.toDateString()===w.toDateString();break}case"week":{const ce=new Date(w.getTime()-6048e5);l=v>=ce;break}case"month":{l=v.getMonth()===w.getMonth()&&v.getFullYear()===w.getFullYear();break}}}return t&&s&&l}),[B,c,g,f]),re=async a=>{try{const{error:t}=await u.from("payments").insert({aid_record_id:a.aid_record_id,beneficiary_id:a.beneficiary_id,payment_method:"bank_transfer",amount:a.amount,bank_account:a.iban,bank_name:a.bank_name,account_number:a.account_number,account_holder:a.account_holder,status:"pending",notes:a.notes});if(t)throw t;p.success("Banka ödeme emri başarıyla oluşturuldu"),x(!1),ee(),C(),T()}catch(t){console.error("Banka ödeme emri oluşturulurken hata:",t),p.error("Banka ödeme emri oluşturulurken hata oluştu")}},ne=async()=>{try{const a=j.map(s=>s.id),{error:t}=await u.from("payments").update({status:"sent",sent_date:new Date().toISOString()}).in("id",a);if(t)throw t;p.success(`${j.length} adet banka ödeme emri gönderildi`),h(!1),A([]),C(),T()}catch(a){console.error("Banka emirleri gönderilirken hata:",a),p.error("Banka emirleri gönderilirken hata oluştu")}},le=a=>{const s={pending:{label:"Beklemede",class:"bg-yellow-100 text-yellow-800",icon:M},sent:{label:"Gönderildi",class:"bg-blue-100 text-blue-800",icon:S},completed:{label:"Tamamlandı",class:"bg-green-100 text-green-800",icon:I},failed:{label:"Başarısız",class:"bg-red-100 text-red-800",icon:Y},cancelled:{label:"İptal Edildi",class:"bg-gray-100 text-gray-800",icon:Y}}[a]||{label:a,class:"bg-gray-100 text-gray-800",icon:R},l=s.icon;return e.jsxs("span",{className:`inline-flex items-center gap-1 rounded-full px-2 py-1 text-xs font-medium ${s.class}`,children:[e.jsx(l,{className:"h-3 w-3"}),s.label]})},N=a=>new Intl.NumberFormat("tr-TR",{style:"currency",currency:"TRY"}).format(a),z=a=>new Date(a).toLocaleDateString("tr-TR"),ie=a=>a.replace(/(.{4})/g,"$1 ").trim(),E=B.filter(a=>a.status==="pending"),oe=[{key:"beneficiaries",header:"İhtiyaç Sahibi",render:(a,t)=>{var s,l,d;return e.jsxs("div",{children:[e.jsxs("div",{className:"font-medium",children:[(s=t.beneficiaries)==null?void 0:s.name," ",(l=t.beneficiaries)==null?void 0:l.surname]}),e.jsx("div",{className:"text-sm text-muted-foreground",children:(d=t.beneficiaries)==null?void 0:d.category})]})}},{key:"amount",header:"Tutar",render:(a,t)=>e.jsx("div",{className:"font-medium text-green-600",children:N(t.amount)})},{key:"bank_info",header:"Banka Bilgileri",render:(a,t)=>e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:t.bank_name}),e.jsx("div",{className:"text-sm text-muted-foreground",children:t.account_holder}),e.jsx("div",{className:"text-xs text-muted-foreground",children:ie(t.iban)})]})},{key:"status",header:"Durum",render:(a,t)=>le(t.status)},{key:"order_date",header:"Emir Tarihi",render:(a,t)=>z(t.order_date)},{key:"sent_date",header:"Gönderim Tarihi",render:(a,t)=>t.sent_date?z(t.sent_date):"-"},{key:"transaction_ref",header:"İşlem Ref.",render:(a,t)=>e.jsx("div",{className:"max-w-xs truncate",title:t.transaction_ref,children:t.transaction_ref||"-"})},{key:"actions",header:"İşlemler",render:(a,t)=>e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{className:"rounded p-1 text-gray-600 hover:bg-gray-50",title:"Detay",children:e.jsx(je,{className:"h-4 w-4"})}),t.status==="pending"&&e.jsx("button",{className:"rounded p-1 text-blue-600 hover:bg-blue-50",title:"Düzenle",children:e.jsx(ye,{className:"h-4 w-4"})})]})}];return H?e.jsx("div",{className:"flex h-64 items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"h-8 w-8 animate-spin rounded-full border-4 border-primary border-t-transparent mx-auto mb-2"}),e.jsx("p",{className:"text-muted-foreground",children:"Yükleniyor..."})]})}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold",children:"Banka Ödeme Emirleri"}),e.jsx("p",{className:"text-muted-foreground",children:"Banka havalesi ile yapılacak ödemeleri yönetin"})]}),e.jsxs("div",{className:"flex gap-2",children:[E.length>0&&e.jsxs("button",{onClick:()=>{A(E),h(!0)},className:"flex items-center gap-2 rounded bg-blue-600 px-4 py-2 text-sm text-white hover:bg-blue-700",children:[e.jsx(S,{className:"h-4 w-4"}),"Toplu Gönder (",E.length,")"]}),e.jsxs("button",{onClick:()=>x(!0),className:"flex items-center gap-2 rounded bg-primary px-4 py-2 text-sm text-white hover:bg-primary/90",children:[e.jsx(L,{className:"h-4 w-4"}),"Yeni Emir"]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-4",children:[e.jsx(_,{title:"Bekleyen Emirler",value:b.totalPending.toString(),icon:e.jsx(M,{className:"h-5 w-5 text-yellow-700"}),accentClass:"bg-yellow-100"}),e.jsx(_,{title:"Gönderilen Emirler",value:b.totalSent.toString(),icon:e.jsx(S,{className:"h-5 w-5 text-blue-700"}),accentClass:"bg-blue-100"}),e.jsx(_,{title:"Tamamlanan Emirler",value:b.totalCompleted.toString(),icon:e.jsx(I,{className:"h-5 w-5 text-green-700"}),accentClass:"bg-green-100"}),e.jsx(_,{title:"Toplam Tutar",value:N(b.totalAmount),icon:e.jsx(be,{className:"h-5 w-5 text-purple-700"}),accentClass:"bg-purple-100"})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-4 rounded-lg border p-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ge,{className:"h-4 w-4 text-muted-foreground"}),e.jsx("input",{type:"text",placeholder:"Emir ara...",value:c,onChange:a=>P(a.target.value),className:"min-w-64 rounded border px-3 py-2 text-sm"})]}),e.jsxs("select",{value:g,onChange:a=>$(a.target.value),className:"rounded border px-3 py-2 text-sm",children:[e.jsx("option",{value:"all",children:"Tüm Durumlar"}),e.jsx("option",{value:"pending",children:"Bekleyen"}),e.jsx("option",{value:"sent",children:"Gönderilen"}),e.jsx("option",{value:"completed",children:"Tamamlanan"}),e.jsx("option",{value:"failed",children:"Başarısız"}),e.jsx("option",{value:"cancelled",children:"İptal Edilen"})]}),e.jsxs("select",{value:f,onChange:a=>Q(a.target.value),className:"rounded border px-3 py-2 text-sm",children:[e.jsx("option",{value:"all",children:"Tüm Tarihler"}),e.jsx("option",{value:"today",children:"Bugün"}),e.jsx("option",{value:"week",children:"Bu Hafta"}),e.jsx("option",{value:"month",children:"Bu Ay"})]}),e.jsxs("button",{onClick:()=>de("banka-odeme-emirleri.csv",D),className:"flex items-center gap-2 rounded bg-green-600 px-3 py-2 text-sm text-white hover:bg-green-700",children:[e.jsx(fe,{className:"h-4 w-4"}),"İndir"]}),e.jsxs("div",{className:"ml-auto text-sm text-muted-foreground",children:[D.length," emir"]})]}),e.jsx(me,{columns:oe,data:D}),e.jsxs(O,{open:V,onClose:()=>x(!1),children:[e.jsxs("div",{className:"flex items-center justify-between border-b p-4",children:[e.jsx("h2",{className:"text-lg font-semibold",children:"Yeni Banka Ödeme Emri"}),e.jsx("button",{onClick:()=>x(!1),className:"h-8 w-8 rounded-full bg-red-600 text-white hover:bg-red-700",children:"×"})]}),e.jsxs("form",{onSubmit:Z(re),className:"p-4 space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"İhtiyaç Sahibi *"}),e.jsxs("select",{...o("beneficiary_id"),className:"w-full rounded border px-3 py-2 text-sm",children:[e.jsx("option",{value:"",children:"Seçiniz..."}),X.map(a=>e.jsxs("option",{value:a.id,children:[a.name," ",a.surname," - ",a.category]},a.id))]}),r.beneficiary_id&&e.jsx("p",{className:"text-sm text-red-600 mt-1",children:r.beneficiary_id.message})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Yardım Kaydı *"}),e.jsxs("select",{...o("aid_record_id"),className:"w-full rounded border px-3 py-2 text-sm",disabled:!y,children:[e.jsx("option",{value:"",children:"Seçiniz..."}),U.map(a=>e.jsxs("option",{value:a.id,children:[a.aid_type," - ",N(a.amount)]},a.id))]}),r.aid_record_id&&e.jsx("p",{className:"text-sm text-red-600 mt-1",children:r.aid_record_id.message})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Tutar *"}),e.jsx("input",{type:"number",step:"0.01",...o("amount",{valueAsNumber:!0}),className:"w-full rounded border px-3 py-2 text-sm",placeholder:"0.00"}),r.amount&&e.jsx("p",{className:"text-sm text-red-600 mt-1",children:r.amount.message})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Banka Adı *"}),e.jsx("input",{type:"text",...o("bank_name"),className:"w-full rounded border px-3 py-2 text-sm",placeholder:"Banka adı"}),r.bank_name&&e.jsx("p",{className:"text-sm text-red-600 mt-1",children:r.bank_name.message})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Hesap Sahibi *"}),e.jsx("input",{type:"text",...o("account_holder"),className:"w-full rounded border px-3 py-2 text-sm",placeholder:"Hesap sahibinin adı"}),r.account_holder&&e.jsx("p",{className:"text-sm text-red-600 mt-1",children:r.account_holder.message})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Hesap Numarası *"}),e.jsx("input",{type:"text",...o("account_number"),className:"w-full rounded border px-3 py-2 text-sm",placeholder:"Hesap numarası"}),r.account_number&&e.jsx("p",{className:"text-sm text-red-600 mt-1",children:r.account_number.message})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"IBAN *"}),e.jsx("input",{type:"text",...o("iban"),className:"w-full rounded border px-3 py-2 text-sm",placeholder:"TR00 0000 0000 0000 0000 0000 00",maxLength:34}),r.iban&&e.jsx("p",{className:"text-sm text-red-600 mt-1",children:r.iban.message})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Notlar"}),e.jsx("textarea",{...o("notes"),rows:3,className:"w-full rounded border px-3 py-2 text-sm",placeholder:"Ödeme emri ile ilgili notlar..."})]}),e.jsxs("div",{className:"flex justify-end gap-2 pt-4",children:[e.jsx("button",{type:"button",onClick:()=>x(!1),className:"rounded border px-4 py-2 text-sm hover:bg-gray-50",children:"İptal"}),e.jsxs("button",{type:"submit",className:"flex items-center gap-2 rounded bg-primary px-4 py-2 text-sm text-white hover:bg-primary/90",children:[e.jsx(L,{className:"h-4 w-4"}),"Oluştur"]})]})]})]}),e.jsxs(O,{open:K,onClose:()=>h(!1),children:[e.jsxs("div",{className:"flex items-center justify-between border-b p-4",children:[e.jsx("h2",{className:"text-lg font-semibold",children:"Toplu Banka Ödeme Emri Gönderimi"}),e.jsx("button",{onClick:()=>h(!1),className:"h-8 w-8 rounded-full bg-red-600 text-white hover:bg-red-700",children:"×"})]}),e.jsxs("div",{className:"p-4 space-y-4",children:[e.jsxs("div",{className:"rounded border p-4 bg-yellow-50",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(R,{className:"h-5 w-5 text-yellow-600"}),e.jsx("h3",{className:"font-medium text-yellow-800",children:"Dikkat"})]}),e.jsxs("p",{className:"text-sm text-yellow-700",children:[j.length," adet banka ödeme emri gönderilecek. Bu işlem geri alınamaz."]})]}),e.jsx("div",{className:"max-h-64 overflow-y-auto",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b",children:[e.jsx("th",{className:"text-left p-2",children:"İhtiyaç Sahibi"}),e.jsx("th",{className:"text-left p-2",children:"Tutar"}),e.jsx("th",{className:"text-left p-2",children:"Banka"})]})}),e.jsx("tbody",{children:j.map(a=>{var t,s;return e.jsxs("tr",{className:"border-b",children:[e.jsxs("td",{className:"p-2",children:[(t=a.beneficiaries)==null?void 0:t.name," ",(s=a.beneficiaries)==null?void 0:s.surname]}),e.jsx("td",{className:"p-2",children:N(a.amount)}),e.jsx("td",{className:"p-2",children:a.bank_name})]},a.id)})})]})}),e.jsxs("div",{className:"flex justify-end gap-2 pt-4",children:[e.jsx("button",{onClick:()=>h(!1),className:"rounded border px-4 py-2 text-sm hover:bg-gray-50",children:"İptal"}),e.jsxs("button",{onClick:ne,className:"flex items-center gap-2 rounded bg-blue-600 px-4 py-2 text-sm text-white hover:bg-blue-700",children:[e.jsx(S,{className:"h-4 w-4"}),"Gönder"]})]})]})]})]})}export{Oe as default};
