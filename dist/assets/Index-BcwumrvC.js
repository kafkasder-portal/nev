import{j as e}from"./query-D2a9LsAW.js";import{r as l}from"./vendor-Ba6jih-_.js";import{B as S,n as Y,o as J,u as le,s as U}from"./index-DdeQrtE8.js";import{u as N,ab as de,S as ee,aW as ue,aX as te,ad as re,k as me,aB as xe,ax as ne,B as he,ac as se,U as q,aY as ge,aG as pe,aZ as fe,aa as ye,X as we,ae,a_ as _e,af as je,w as ie,ap as ve,K as be,aP as Ne,I as Se}from"./ui-yrixFDMZ.js";import{V as B}from"./index-v3sBR1NV.js";import"./router-PzPojOO1.js";import"./supabase-B5p9Wfie.js";const h=(t,s)=>{console.error(`${s}:`,t);const r=(t==null?void 0:t.message)||`Error in ${s}`;throw N.error(r),new Error(r)},X=()=>[{id:"conv_1",name:"Yönetim Kurulu",conversation_type:"group",created_by:"user1",description:"Yönetim kurulu iç iletişimi",is_archived:!1,last_message_at:new Date(Date.now()-30*60*1e3).toISOString(),created_at:new Date(Date.now()-30*24*60*60*1e3).toISOString(),updated_at:new Date().toISOString()},{id:"conv_2",name:"Proje Koordinasyonu",conversation_type:"group",created_by:"user2",description:"Aktif projeler için koordinasyon",is_archived:!1,last_message_at:new Date(Date.now()-2*60*60*1e3).toISOString(),created_at:new Date(Date.now()-15*24*60*60*1e3).toISOString(),updated_at:new Date().toISOString()},{id:"conv_3",conversation_type:"direct",created_by:"user1",is_archived:!1,last_message_at:new Date(Date.now()-5*60*1e3).toISOString(),created_at:new Date(Date.now()-7*24*60*60*1e3).toISOString(),updated_at:new Date().toISOString()}],Z=t=>[{id:"msg_1",sender_id:"user1",conversation_id:t,content:"Merhaba, toplantı için gündem maddelerini gözden geçirelim.",message_type:"text",created_at:new Date(Date.now()-60*60*1e3).toISOString(),updated_at:new Date(Date.now()-60*60*1e3).toISOString()},{id:"msg_2",sender_id:"user2",conversation_id:t,content:"Evet, bütçe konularını da ekleyelim. Dosyayı paylaşıyorum.",message_type:"text",created_at:new Date(Date.now()-45*60*1e3).toISOString(),updated_at:new Date(Date.now()-45*60*1e3).toISOString()},{id:"msg_3",sender_id:"user2",conversation_id:t,content:"budget_2024.pdf",message_type:"file",file_url:"https://example.com/budget_2024.pdf",file_name:"budget_2024.pdf",file_size:245760,created_at:new Date(Date.now()-30*60*1e3).toISOString(),updated_at:new Date(Date.now()-30*60*1e3).toISOString()},{id:"msg_4",sender_id:"user3",conversation_id:t,content:"Harika! Ben de proje raporlarını hazırladım. Yarın sunabilirim.",message_type:"text",reply_to:"msg_2",created_at:new Date(Date.now()-15*60*1e3).toISOString(),updated_at:new Date(Date.now()-15*60*1e3).toISOString()},{id:"msg_5",sender_id:"user1",conversation_id:t,content:"Mükemmel! O zaman yarın saat 14:00'da başlayalım.",message_type:"text",created_at:new Date(Date.now()-5*60*1e3).toISOString(),updated_at:new Date(Date.now()-5*60*1e3).toISOString()}],ke=t=>[{id:"part_1",conversation_id:t,user_id:"user1",role:"admin",joined_at:new Date(Date.now()-30*24*60*60*1e3).toISOString(),is_muted:!1,last_read_at:new Date(Date.now()-10*60*1e3).toISOString()},{id:"part_2",conversation_id:t,user_id:"user2",role:"member",joined_at:new Date(Date.now()-25*24*60*60*1e3).toISOString(),is_muted:!1,last_read_at:new Date(Date.now()-20*60*1e3).toISOString()},{id:"part_3",conversation_id:t,user_id:"user3",role:"member",joined_at:new Date(Date.now()-20*24*60*60*1e3).toISOString(),is_muted:!1,last_read_at:new Date(Date.now()-5*60*1e3).toISOString()}],D={async getConversations(){try{return X()}catch(t){return h(t,"getConversations"),[]}},async getConversation(t){try{return X().find(r=>r.id===t)||null}catch(s){return h(s,"getConversation"),null}},async createConversation(t){try{const s={id:`conv_${Date.now()}`,name:t.name,conversation_type:t.conversation_type,created_by:"current_user",description:t.description,is_archived:!1,created_at:new Date().toISOString(),updated_at:new Date().toISOString()};return t.participants.length>0&&await this.addParticipants(s.id,t.participants),N.success("Konuşma oluşturuldu"),s}catch(s){throw h(s,"createConversation"),s}},async updateConversation(t,s){try{const i=X().find(x=>x.id===t);if(!i)throw new Error("Konuşma bulunamadı");const d={...i,...s,updated_at:new Date().toISOString()};return N.success("Konuşma güncellendi"),d}catch(r){throw h(r,"updateConversation"),r}},async deleteConversation(t){try{N.success("Konuşma silindi")}catch(s){throw h(s,"deleteConversation"),s}},async archiveConversation(t){try{N.success("Konuşma arşivlendi")}catch(s){throw h(s,"archiveConversation"),s}},async getMessages(t){try{return Z(t)}catch(s){return h(s,"getMessages"),[]}},async sendMessage(t){try{const s={id:`msg_${Date.now()}`,sender_id:"current_user",conversation_id:t.conversation_id,content:t.content,message_type:t.message_type||"text",file_url:t.file_url,file_name:t.file_name,file_size:t.file_size,reply_to:t.reply_to,created_at:new Date().toISOString(),updated_at:new Date().toISOString()};return await this.updateConversationLastMessage(t.conversation_id),s}catch(s){throw h(s,"sendMessage"),s}},async editMessage(t,s){try{const i=Z("conv_1").find(x=>x.id===t);if(!i)throw new Error("Mesaj bulunamadı");const d={...i,content:s,edited_at:new Date().toISOString(),updated_at:new Date().toISOString()};return N.success("Mesaj düzenlendi"),d}catch(r){throw h(r,"editMessage"),r}},async deleteMessage(t){try{N.success("Mesaj silindi")}catch(s){throw h(s,"deleteMessage"),s}},async markMessageAsRead(t){},async getConversationParticipants(t){try{return ke(t)}catch(s){return h(s,"getConversationParticipants"),[]}},async addParticipants(t,s){try{const r=s.map(i=>({id:`part_${Date.now()}_${i}`,conversation_id:t,user_id:i,role:"member",joined_at:new Date().toISOString(),is_muted:!1}));return N.success(`${s.length} katılımcı eklendi`),r}catch(r){throw h(r,"addParticipants"),r}},async removeParticipant(t,s){try{N.success("Katılımcı çıkarıldı")}catch(r){throw h(r,"removeParticipant"),r}},async updateParticipantRole(t,s,r){try{N.success("Katılımcı rolü güncellendi")}catch(i){throw h(i,"updateParticipantRole"),i}},async muteConversation(t,s,r){try{N.success(r?"Konuşma sessize alındı":"Konuşma sessize alma kaldırıldı")}catch(i){throw h(i,"muteConversation"),i}},async markConversationAsRead(t){},async addReaction(t,s){try{return{id:`reaction_${Date.now()}`,message_id:t,user_id:"current_user",emoji:s,created_at:new Date().toISOString()}}catch(r){throw h(r,"addReaction"),r}},async removeReaction(t){},async getMessageReactions(t){try{return[{id:"reaction_1",message_id:t,user_id:"user1",emoji:"👍",created_at:new Date().toISOString()},{id:"reaction_2",message_id:t,user_id:"user2",emoji:"❤️",created_at:new Date().toISOString()}]}catch(s){return h(s,"getMessageReactions"),[]}},async searchMessages(t,s){try{return Z(s||"conv_1").filter(i=>i.content.toLowerCase().includes(t.toLowerCase()))}catch(r){return h(r,"searchMessages"),[]}},async getNotifications(t){try{return[{id:"notif_1",user_id:t,conversation_id:"conv_1",message_id:"msg_1",type:"new_message",is_read:!1,created_at:new Date(Date.now()-18e5).toISOString()},{id:"notif_2",user_id:t,conversation_id:"conv_2",message_id:"msg_2",type:"mention",is_read:!1,created_at:new Date(Date.now()-36e5).toISOString()}]}catch(s){return h(s,"getNotifications"),[]}},async markNotificationAsRead(t){},subscribeToConversation(t,s){return console.log(`Subscribed to conversation ${t}`),{unsubscribe:()=>console.log(`Unsubscribed from conversation ${t}`)}},subscribeToNotifications(t,s){return console.log(`Subscribed to notifications for user ${t}`),{unsubscribe:()=>console.log(`Unsubscribed from notifications for user ${t}`)}},async updateConversationLastMessage(t){},async getUnreadCount(t,s){try{return Math.floor(Math.random()*5)}catch(r){return console.error("Failed to get unread count:",r),0}}};function De({conversations:t,selectedConversationId:s,onSelectConversation:r,onCreateConversation:i,onSearchConversations:d,onUpdateConversations:x,loading:w=!1,currentUserId:f}){const[u,M]=l.useState(""),[k,p]=l.useState(null),[g,_]=l.useState({}),[$,E]=l.useState(new Set),[j,R]=l.useState("all");l.useEffect(()=>{(async()=>{if(!f)return;const c={};for(const b of t)try{const v=await D.getUnreadCount(b.id,f);c[b.id]=v}catch(v){console.error("Failed to load unread count:",v)}_(c)})()},[t,f]),l.useEffect(()=>{E(new Set(["user1","user2","user3"]))},[]),l.useEffect(()=>{const a=()=>p(null);return document.addEventListener("click",a),()=>document.removeEventListener("click",a)},[]);const P=a=>{M(a),d==null||d(a)},z=t.filter(a=>{var v,V;const c=!u||((v=a.name)==null?void 0:v.toLowerCase().includes(u.toLowerCase()))||((V=a.description)==null?void 0:V.toLowerCase().includes(u.toLowerCase())),b=j==="all"||j==="unread"&&(g[a.id]||0)>0||j==="groups"&&a.conversation_type==="group"||j==="direct"&&a.conversation_type==="direct";return c&&b&&!a.is_archived}),K=a=>{if(!a)return"";const c=new Date(a),v=(new Date().getTime()-c.getTime())/(1e3*60*60);return v<1?"şimdi":v<24?Y(c,"HH:mm"):v<168?Y(c,"EEE",{locale:J}):Y(c,"dd/MM",{locale:J})},T=a=>a.conversation_type==="group"?a.name||"İsimsiz Grup":"Direkt Mesaj",H=a=>a.avatar_url?e.jsx("img",{src:a.avatar_url,alt:T(a),className:"w-12 h-12 rounded-full object-cover"}):e.jsxs("div",{className:"w-12 h-12 bg-primary rounded-full flex items-center justify-center text-white relative",children:[a.conversation_type==="group"?e.jsx(q,{className:"h-6 w-6"}):e.jsx(se,{className:"h-6 w-6"}),a.conversation_type==="direct"&&$.has("user1")&&e.jsx("div",{className:"absolute -bottom-0.5 -right-0.5 w-4 h-4 bg-green-500 border-2 border-white rounded-full"})]}),o=(a,c)=>{a.stopPropagation(),p(k===c?null:c)},y=async a=>{try{await D.archiveConversation(a),x==null||x(),p(null)}catch(c){console.error("Failed to archive conversation:",c)}},I=async(a,c)=>{if(f)try{await D.muteConversation(a,f,c),p(null)}catch(b){console.error("Failed to mute conversation:",b)}},G=async a=>{if(window.confirm("Bu konuşmayı silmek istediğinizden emin misiniz?"))try{await D.deleteConversation(a),x==null||x(),p(null)}catch(c){console.error("Failed to delete conversation:",c)}},W=()=>{p(null)},Q=a=>g[a]||0;return e.jsxs("div",{className:"w-80 border-r bg-card flex flex-col h-full",children:[e.jsxs("div",{className:"p-4 border-b",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h2",{className:"font-semibold text-lg",children:"Mesajlar"}),i&&e.jsxs(S,{size:"sm",onClick:i,children:[e.jsx(de,{className:"h-4 w-4 mr-2"}),"Yeni"]})]}),e.jsxs("div",{className:"relative mb-3",children:[e.jsx(ee,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-muted-foreground h-4 w-4"}),e.jsx("input",{type:"text",placeholder:"Konuşma ara...",value:u,onChange:a=>P(a.target.value),className:"w-full pl-10 pr-3 py-2 border border-input rounded-md bg-background text-sm"})]}),e.jsx("div",{className:"flex space-x-1 p-1 bg-muted rounded-lg",children:[{id:"all",label:"Tümü",count:t.length},{id:"unread",label:"Okunmayan",count:Object.values(g).reduce((a,c)=>a+(c>0?1:0),0)},{id:"groups",label:"Gruplar",count:t.filter(a=>a.conversation_type==="group").length},{id:"direct",label:"Direkt",count:t.filter(a=>a.conversation_type==="direct").length}].map(a=>e.jsxs("button",{onClick:()=>R(a.id),className:`flex-1 text-xs py-1.5 px-2 rounded transition-colors ${j===a.id?"bg-background text-foreground shadow-sm":"text-muted-foreground hover:text-foreground"}`,children:[a.label,a.count>0&&e.jsxs("span",{className:"ml-1 text-xs",children:["(",a.count,")"]})]},a.id))})]}),e.jsx("div",{className:"flex-1 overflow-y-auto",children:w?e.jsxs("div",{className:"p-4 text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-6 w-6 border-b-2 border-primary mx-auto"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-2",children:"Yükleniyor..."})]}):z.length>0?e.jsx("div",{className:"space-y-1 p-2",children:z.map(a=>{const c=Q(a.id);return e.jsxs("div",{className:`relative group cursor-pointer rounded-lg p-3 transition-colors ${s===a.id?"bg-primary/10 border border-primary/20":"hover:bg-muted/50"}`,onClick:()=>r(a),children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[H(a),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("h3",{className:`truncate ${c>0?"font-semibold":"font-medium"}`,children:T(a)}),a.conversation_type==="group"&&e.jsx(ue,{className:"h-3 w-3 text-muted-foreground"}),e.jsx(te,{className:"h-3 w-3 text-muted-foreground opacity-0"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[c>0&&e.jsx("span",{className:"bg-primary text-primary-foreground text-xs px-2 py-0.5 rounded-full min-w-[18px] text-center font-medium",children:c>99?"99+":c}),a.last_message_at&&e.jsx("span",{className:"text-xs text-muted-foreground",children:K(a.last_message_at)}),e.jsx("button",{onClick:b=>o(b,a.id),className:"opacity-0 group-hover:opacity-100 p-1 hover:bg-background/50 rounded transition-opacity",children:e.jsx(re,{className:"h-4 w-4"})})]})]}),e.jsx("div",{className:"flex items-center justify-between mt-1",children:e.jsx("p",{className:`text-sm truncate ${c>0?"text-foreground":"text-muted-foreground"}`,children:a.description||"Henüz mesaj yok"})})]})]}),k===a.id&&e.jsxs("div",{className:"absolute top-12 right-3 bg-background border rounded-lg shadow-lg z-20 min-w-[160px]",children:[e.jsxs("button",{className:"w-full text-left px-3 py-2 text-sm hover:bg-muted rounded-t-lg flex items-center",onClick:()=>I(a.id,!0),children:[e.jsx(te,{className:"h-4 w-4 mr-2"}),"Sessize Al"]}),a.conversation_type==="group"&&e.jsxs("button",{className:"w-full text-left px-3 py-2 text-sm hover:bg-muted flex items-center",children:[e.jsx(me,{className:"h-4 w-4 mr-2"}),"Grup Ayarları"]}),e.jsxs("button",{className:"w-full text-left px-3 py-2 text-sm hover:bg-muted flex items-center",onClick:()=>y(a.id),children:[e.jsx(xe,{className:"h-4 w-4 mr-2"}),"Arşivle"]}),e.jsx("div",{className:"border-t border-muted my-1"}),e.jsxs("button",{className:"w-full text-left px-3 py-2 text-sm hover:bg-muted rounded-b-lg flex items-center text-destructive",onClick:()=>G(a.id),children:[e.jsx(ne,{className:"h-4 w-4 mr-2"}),a.conversation_type==="group"?"Gruptan Ayrıl":"Konuşmayı Sil"]})]})]},a.id)})}):e.jsx("div",{className:"p-8 text-center text-muted-foreground",children:u?e.jsxs("div",{children:[e.jsx(ee,{className:"h-8 w-8 mx-auto mb-2 opacity-50"}),e.jsx("p",{children:"Arama kriterlerine uygun konuşma bulunamadı"}),e.jsxs("p",{className:"text-xs mt-1",children:["'",u,"' için sonuç yok"]})]}):j==="unread"?e.jsxs("div",{children:[e.jsx(he,{className:"h-8 w-8 mx-auto mb-2 opacity-50"}),e.jsx("p",{children:"Okunmamış mesaj yok"})]}):e.jsxs("div",{children:[e.jsx(se,{className:"h-8 w-8 mx-auto mb-2 opacity-50"}),e.jsx("p",{children:"Henüz konuşma başlatılmamış"}),i&&e.jsx(S,{size:"sm",className:"mt-3",onClick:i,children:"İlk konuşmayı başlat"})]})})}),k&&e.jsx("div",{className:"fixed inset-0 z-10",onClick:W})]})}function Me({message:t,isCurrentUser:s,onReply:r,onEdit:i,onDelete:d,showSender:x=!0,onFileDownload:w}){const[f,u]=l.useState(!1),M=p=>{const g=new Date(p),_=new Date;return g.toDateString()===_.toDateString()?Y(g,"HH:mm"):Y(g,"dd MMM HH:mm",{locale:J})},k=()=>{switch(t.message_type){case"file":return e.jsxs("div",{className:"flex items-center space-x-3 p-3 border rounded-lg bg-muted/50",children:[e.jsx(fe,{className:"h-8 w-8 text-blue-500"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"font-medium",children:t.file_name}),t.file_size&&e.jsxs("div",{className:"text-sm text-muted-foreground",children:[(t.file_size/1024/1024).toFixed(2)," MB"]})]}),t.file_url&&e.jsx("button",{onClick:()=>w==null?void 0:w(t.file_url,t.file_name),className:"p-2 hover:bg-muted rounded-md",children:e.jsx(ye,{className:"h-4 w-4"})})]});case"image":return e.jsxs("div",{className:"space-y-2",children:[t.file_url&&e.jsx("img",{src:t.file_url,alt:t.file_name||"Resim",className:"max-w-xs rounded-lg cursor-pointer hover:opacity-90",onClick:()=>window.open(t.file_url,"_blank")}),t.content&&e.jsx("div",{className:"text-sm",children:t.content})]});case"system":return e.jsx("div",{className:"text-sm text-muted-foreground italic",children:t.content});default:return e.jsx("div",{className:"whitespace-pre-wrap break-words",children:t.content})}};return e.jsxs("div",{className:`flex gap-3 group ${s?"flex-row-reverse":""}`,children:[x&&!s&&e.jsx("div",{className:"w-8 h-8 bg-primary rounded-full flex items-center justify-center text-white text-sm flex-shrink-0",children:t.sender_id.charAt(0).toUpperCase()}),e.jsxs("div",{className:`flex-1 max-w-xs sm:max-w-md ${s?"flex flex-col items-end":""}`,children:[x&&!s&&e.jsxs("div",{className:"text-sm text-muted-foreground mb-1",children:["Kullanıcı ",t.sender_id]}),t.reply_to&&e.jsxs("div",{className:"mb-2 p-2 bg-muted/50 border-l-2 border-primary rounded text-sm",children:[e.jsx("div",{className:"text-muted-foreground",children:"Yanıtlanan mesaj"}),e.jsx("div",{className:"truncate",children:"..."})]}),e.jsxs("div",{className:`relative rounded-lg p-3 ${t.message_type==="system"?"bg-muted/30 text-center":s?"bg-primary text-primary-foreground":"bg-card border"}`,children:[k(),e.jsxs("div",{className:`text-xs mt-2 ${t.message_type==="system"?"text-muted-foreground":s?"text-primary-foreground/70":"text-muted-foreground"}`,children:[M(t.created_at),t.edited_at&&e.jsx("span",{className:"ml-1",children:"(düzenlendi)"})]}),t.message_type!=="system"&&e.jsx("div",{className:"absolute top-1 right-1 opacity-0 group-hover:opacity-100 transition-opacity",children:e.jsxs("div",{className:"relative",children:[e.jsx("button",{onClick:()=>u(!f),className:"p-1 hover:bg-background/20 rounded",children:e.jsx(re,{className:"h-3 w-3"})}),f&&e.jsxs("div",{className:"absolute top-full right-0 mt-1 bg-background border rounded-lg shadow-lg z-10 min-w-[120px]",children:[r&&e.jsxs("button",{onClick:()=>{r(t),u(!1)},className:"w-full text-left px-3 py-2 text-sm hover:bg-muted rounded-t-lg flex items-center",children:[e.jsx(ge,{className:"h-3 w-3 mr-2"}),"Yanıtla"]}),s&&i&&t.message_type==="text"&&e.jsxs("button",{onClick:()=>{i(t),u(!1)},className:"w-full text-left px-3 py-2 text-sm hover:bg-muted flex items-center",children:[e.jsx(pe,{className:"h-3 w-3 mr-2"}),"Düzenle"]}),s&&d&&e.jsxs("button",{onClick:()=>{d(t.id),u(!1)},className:"w-full text-left px-3 py-2 text-sm hover:bg-muted rounded-b-lg flex items-center text-red-600",children:[e.jsx(ne,{className:"h-3 w-3 mr-2"}),"Sil"]})]})]})})]})]}),f&&e.jsx("div",{className:"fixed inset-0 z-5",onClick:()=>u(!1)})]})}function Ce({onSendMessage:t,onFileUpload:s,replyingTo:r,onCancelReply:i,disabled:d=!1,placeholder:x="Mesajınızı yazın..."}){const[w,f]=l.useState(""),[u,M]=l.useState(!1),[k,p]=l.useState(!1),g=l.useRef(null),_=l.useRef(null),$=async()=>{w.trim()&&!d&&(t(w.trim()),f(""),_.current&&(_.current.style.height="auto"))},E=o=>{o.key==="Enter"&&!o.shiftKey&&(o.preventDefault(),$())},j=async o=>{if(s){M(!0);try{const y=await s(o),I=o.type.startsWith("image/")?"image":"file";t(o.type.startsWith("image/")?"":`📎 ${y.name}`,I)}catch(y){console.error("File upload failed:",y)}finally{M(!1)}}},R=o=>{var I;const y=(I=o.target.files)==null?void 0:I[0];y&&j(y)},P=o=>{o.preventDefault(),p(!1);const y=o.dataTransfer.files[0];y&&j(y)},z=o=>{o.preventDefault(),p(!0)},K=o=>{o.preventDefault(),p(!1)},T=o=>{o.style.height="auto",o.style.height=Math.min(o.scrollHeight,120)+"px"},H=o=>{f(o.target.value),T(o.target)};return e.jsxs("div",{className:"border-t bg-background p-4",children:[r&&e.jsxs("div",{className:"mb-3 p-3 bg-muted/50 border-l-2 border-primary rounded flex items-center justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"text-sm text-muted-foreground",children:["Kullanıcı ",r.sender_id," kullanıcısına yanıt veriyor"]}),e.jsx("div",{className:"text-sm truncate mt-1",children:r.content||(r.message_type==="file"?`📎 ${r.file_name}`:"Dosya")})]}),i&&e.jsx(S,{size:"sm",variant:"ghost",onClick:i,children:e.jsx(we,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:`relative ${k?"bg-primary/10 border-primary":""}`,onDrop:P,onDragOver:z,onDragLeave:K,children:[k&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-primary/5 border-2 border-dashed border-primary rounded-lg z-10",children:e.jsxs("div",{className:"text-center",children:[e.jsx(ae,{className:"h-8 w-8 mx-auto text-primary mb-2"}),e.jsx("p",{className:"text-primary font-medium",children:"Dosyayı buraya bırakın"})]})}),e.jsxs("div",{className:"flex items-end space-x-2",children:[s&&e.jsxs("div",{className:"flex space-x-1",children:[e.jsx("input",{ref:g,type:"file",onChange:R,className:"hidden",accept:"*/*"}),e.jsx(S,{type:"button",size:"sm",variant:"ghost",onClick:()=>{var o;return(o=g.current)==null?void 0:o.click()},disabled:d||u,className:"p-2",children:e.jsx(ae,{className:"h-4 w-4"})}),e.jsx(S,{type:"button",size:"sm",variant:"ghost",onClick:()=>{g.current&&(g.current.accept="image/*",g.current.click())},disabled:d||u,className:"p-2",children:e.jsx(_e,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"flex-1 relative",children:[e.jsx("textarea",{ref:_,value:w,onChange:H,onKeyPress:E,placeholder:u?"Dosya yükleniyor...":x,disabled:d||u,className:"w-full min-h-[40px] max-h-[120px] px-3 py-2 border border-input rounded-md bg-background resize-none focus:ring-2 focus:ring-ring focus:border-transparent",rows:1}),e.jsx(S,{type:"button",size:"sm",variant:"ghost",className:"absolute right-2 top-1/2 transform -translate-y-1/2 p-1",disabled:d,children:e.jsx(je,{className:"h-4 w-4"})})]}),e.jsx(S,{onClick:$,disabled:!w.trim()||d||u,size:"sm",className:"p-2",children:e.jsx(ie,{className:"h-4 w-4"})})]}),u&&e.jsxs("div",{className:"mt-2 text-sm text-muted-foreground flex items-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-primary mr-2"}),"Dosya yükleniyor..."]})]}),e.jsxs("div",{className:"mt-2 text-xs text-muted-foreground",children:[e.jsx("span",{children:"Enter ile gönder, Shift+Enter ile yeni satır"}),s&&e.jsx("span",{className:"ml-2",children:"• Dosya yüklemek için sürükleyip bırakabilirsiniz"})]})]})}function Ke(){const[t,s]=l.useState([]),[r,i]=l.useState(null),[d,x]=l.useState([]),[w,f]=l.useState([]),[u,M]=l.useState(!0),[k,p]=l.useState(!1),[g,_]=l.useState(null),[$,E]=l.useState(null),[j,R]=l.useState(!0),P=l.useRef(null),{user:z}=le(),K=z==null?void 0:z.id;l.useEffect(()=>{H()},[!0]),l.useEffect(()=>{r&&(o(r.id),y(r.id),R(!1))},[r]),l.useEffect(()=>{I()},[d]);const H=async()=>{M(!0);try{const n=await D.getConversations();s(n)}catch(n){console.error("Failed to fetch conversations:",n),B.error("Konuşmalar yüklenirken hata oluştu")}finally{M(!1)}},o=async n=>{p(!0);try{const m=await D.getMessages(n);x(m),await D.markConversationAsRead(n)}catch(m){console.error("Failed to fetch messages:",m),B.error("Mesajlar yüklenirken hata oluştu")}finally{p(!1)}},y=async n=>{try{const m=await D.getConversationParticipants(n);f(m)}catch(m){console.error("Failed to fetch participants:",m)}},I=()=>{var n;(n=P.current)==null||n.scrollIntoView({behavior:"smooth"})},G=async(n,m="text")=>{if(r)try{const C={conversation_id:r.id,content:n,message_type:m,reply_to:g==null?void 0:g.id},A=await D.sendMessage(C);x(L=>[...L,A]),_(null),s(L=>L.map(O=>O.id===r.id?{...O,last_message_at:A.created_at}:O))}catch(C){console.error("Failed to send message:",C),B.error("Mesaj gönderilirken hata oluştu")}},W=async n=>{try{const C=["image/jpeg","image/png","image/gif","application/pdf","text/plain","application/msword","application/vnd.openxmlformats-officedocument.wordprocessingml.document"];if(n.size>10485760)throw new Error("Dosya boyutu 10MB'den küçük olmalıdır");if(!C.includes(n.type))throw new Error("Desteklenmeyen dosya türü");const A=n.name.split(".").pop(),O=`internal-messages/${`${Date.now()}_${Math.random().toString(36).substring(2)}.${A}`}`,{error:F}=await U.storage.from("uploads").upload(O,n);if(F)throw F;const{data:ce}=U.storage.from("uploads").getPublicUrl(O);return{url:ce.publicUrl,name:n.name,size:n.size,path:O}}catch(m){throw console.error("File upload error:",m),m}},Q=async n=>{E(n)},a=async n=>{if(window.confirm("Bu mesajı silmek istediğinizden emin misiniz?"))try{await D.deleteMessage(n),x(m=>m.filter(C=>C.id!==n)),B.success("Mesaj silindi")}catch(m){console.error("Failed to delete message:",m),B.error("Mesaj silinirken hata oluştu")}},c=n=>{_(n)},b=n=>{i(n),x([]),_(null),E(null)},v=()=>{R(!0),i(null)},V=()=>w.filter(n=>!n.left_at).length,oe=()=>r?r.conversation_type==="group"?r.name||"İsimsiz Grup":"Direkt Mesaj":"";return e.jsxs("div",{className:"h-[calc(100vh-8rem)] flex bg-background",children:[e.jsx("div",{className:`${j?"block":"hidden"} md:block`,children:e.jsx(De,{conversations:t,selectedConversationId:r==null?void 0:r.id,onSelectConversation:b,onCreateConversation:()=>{},loading:u,currentUserId:K})}),e.jsx("div",{className:`flex-1 flex flex-col ${j?"hidden":"flex"} md:flex`,children:r?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"p-4 border-b bg-card flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(S,{variant:"ghost",size:"sm",className:"md:hidden",onClick:v,children:e.jsx(ve,{className:"h-4 w-4"})}),e.jsx("div",{className:"w-10 h-10 bg-primary rounded-full flex items-center justify-center text-white",children:r.conversation_type==="group"?e.jsx(q,{className:"h-5 w-5"}):"U"}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold",children:oe()}),e.jsx("p",{className:"text-sm text-muted-foreground",children:r.conversation_type==="group"?`${V()} katılımcı`:"Aktif"})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(S,{variant:"ghost",size:"sm",children:e.jsx(be,{className:"h-4 w-4"})}),e.jsx(S,{variant:"ghost",size:"sm",children:e.jsx(Ne,{className:"h-4 w-4"})}),e.jsx(S,{variant:"ghost",size:"sm",children:e.jsx(Se,{className:"h-4 w-4"})})]})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-4 space-y-4",children:k?e.jsxs("div",{className:"text-center py-8",children:[e.jsx("div",{className:"animate-spin rounded-full h-6 w-6 border-b-2 border-primary mx-auto"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-2",children:"Mesajlar yükleniyor..."})]}):d.length>0?e.jsxs(e.Fragment,{children:[d.map((n,m)=>{const C=n.sender_id===K,A=m===0||d[m-1].sender_id!==n.sender_id||new Date(n.created_at).getTime()-new Date(d[m-1].created_at).getTime()>5*60*1e3;return e.jsx(Me,{message:n,isCurrentUser:C,showSender:A&&r.conversation_type==="group",onReply:c,onEdit:Q,onDelete:a,onFileDownload:(L,O)=>{const F=document.createElement("a");F.href=L,F.download=O,F.click()}},n.id)}),e.jsx("div",{ref:P})]}):e.jsxs("div",{className:"text-center py-8 text-muted-foreground",children:[e.jsx(ie,{className:"h-8 w-8 mx-auto mb-2 opacity-50"}),e.jsx("p",{children:"Henüz mesaj yok"}),e.jsx("p",{className:"text-sm",children:"İlk mesajı göndererek konuşmayı başlatın"})]})}),e.jsx(Ce,{onSendMessage:G,onFileUpload:W,replyingTo:g,onCancelReply:()=>_(null),placeholder:"Mesajınızı yazın..."})]}):e.jsx("div",{className:"flex-1 flex items-center justify-center text-center bg-muted/20",children:e.jsxs("div",{children:[e.jsx(q,{className:"h-16 w-16 mx-auto mb-4 text-muted-foreground/50"}),e.jsx("h3",{className:"text-lg font-medium text-muted-foreground",children:"Konuşma Seçin"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:"Mesajlaşmaya başlamak için soldaki listeden bir konuşma seçin"})]})})})]})}export{Ke as default};
