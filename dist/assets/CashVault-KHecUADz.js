import{j as e}from"./query-D2a9LsAW.js";import{r as l}from"./vendor-Ba6jih-_.js";import{s as u}from"./index-DdeQrtE8.js";import{e as ee}from"./exportToCsv-CTUkvpR5.js";import{D as te}from"./DataTable-Dzg2kqPW.js";import{M as ae}from"./Modal-BazkrsRl.js";import{S as v}from"./StatCard-R_-DmWX7.js";import{u as se,t as re,o as ne,s as _,e as oe}from"./types-Vcb-PP2J.js";import{V as D}from"./index-v3sBR1NV.js";import{aI as N,T as O,W as le,d as ie,S as ce,aa as de,D as I,X as me,ao as ue}from"./ui-yrixFDMZ.js";import"./router-PzPojOO1.js";import"./supabase-B5p9Wfie.js";const he=ne({payment_method:oe(["cash","bank_transfer","check"],{message:"Ödeme yöntemi seçiniz"}),bank_account:_().optional(),transaction_ref:_().optional(),notes:_().optional()});function De(){var Y,E,F;const[S,L]=l.useState([]),[p,q]=l.useState({totalApproved:0,totalDistributed:0,pendingDistribution:0,monthlyTotal:0}),[A,H]=l.useState(!0),[h,V]=l.useState(""),[b,$]=l.useState("all"),[y,z]=l.useState("all"),[K,x]=l.useState(!1),[r,T]=l.useState(null),{register:g,handleSubmit:P,formState:{errors:C},reset:Q,watch:W}=se({resolver:re(he)}),k=W("payment_method");l.useEffect(()=>{M(),R()},[]);const M=async()=>{try{const{data:t,error:a}=await u.from("aid_records").select(`
          *,
          beneficiaries (
            name,
            surname,
            phone,
            category
          ),
          payments (
            id,
            payment_method,
            amount,
            status,
            paid_at
          )
        `).eq("aid_type","cash").order("created_at",{ascending:!1});if(a)throw a;L(t||[])}catch(t){console.error("Nakdi yardım kayıtları yüklenirken hata:",t),D.error("Nakdi yardım kayıtları yüklenirken hata oluştu")}finally{H(!1)}},R=async()=>{try{const{data:t}=await u.from("aid_records").select("amount").eq("aid_type","cash").eq("status","approved"),a=(t==null?void 0:t.reduce((o,i)=>o+(i.amount||0),0))||0,{data:s}=await u.from("aid_records").select("amount").eq("aid_type","cash").in("status",["distributed","completed"]),n=(s==null?void 0:s.reduce((o,i)=>o+(i.amount||0),0))||0,f=a-n,j=new Date().toISOString().slice(0,7),{data:d}=await u.from("aid_records").select("amount").eq("aid_type","cash").gte("created_at",`${j}-01`),m=(d==null?void 0:d.reduce((o,i)=>o+(i.amount||0),0))||0;q({totalApproved:a,totalDistributed:n,pendingDistribution:f,monthlyTotal:m})}catch(t){console.error("İstatistikler yüklenirken hata:",t)}},w=l.useMemo(()=>S.filter(t=>{var f,j,d;const a=h===""||`${(f=t.beneficiaries)==null?void 0:f.name} ${(j=t.beneficiaries)==null?void 0:j.surname}`.toLowerCase().includes(h.toLowerCase())||((d=t.notes)==null?void 0:d.toLowerCase().includes(h.toLowerCase())),s=b==="all"||t.status===b;let n=!0;if(y!=="all"){const m=new Date(t.created_at),o=new Date;switch(y){case"today":{n=m.toDateString()===o.toDateString();break}case"week":{const i=new Date(o.getTime()-6048e5);n=m>=i;break}case"month":{n=m.getMonth()===o.getMonth()&&m.getFullYear()===o.getFullYear();break}}}return a&&s&&n}),[S,h,b,y]),U=async t=>{if(r)try{const{error:a}=await u.from("payments").insert({aid_record_id:r.id,payment_method:t.payment_method,amount:r.amount,bank_account:t.bank_account,transaction_ref:t.transaction_ref,status:"completed",paid_at:new Date().toISOString(),notes:t.notes});if(a)throw a;const{error:s}=await u.from("aid_records").update({status:"distributed",distributed_at:new Date().toISOString()}).eq("id",r.id);if(s)throw s;D.success("Nakdi yardım başarıyla dağıtıldı"),x(!1),T(null),Q(),M(),R()}catch(a){console.error("Nakdi yardım dağıtılırken hata:",a),D.error("Nakdi yardım dağıtılırken hata oluştu")}},X=t=>{const s={approved:{label:"Onaylandı",class:"bg-green-100 text-green-800",icon:N},distributed:{label:"Dağıtıldı",class:"bg-blue-100 text-blue-800",icon:O},completed:{label:"Tamamlandı",class:"bg-purple-100 text-purple-800",icon:N},cancelled:{label:"İptal Edildi",class:"bg-red-100 text-red-800",icon:me}}[t]||{label:t,class:"bg-gray-100 text-gray-800",icon:N},n=s.icon;return e.jsxs("span",{className:`inline-flex items-center gap-1 rounded-full px-2 py-1 text-xs font-medium ${s.class}`,children:[e.jsx(n,{className:"h-3 w-3"}),s.label]})},G=t=>({cash:"Nakit",bank_transfer:"Banka Havalesi",check:"Çek"})[t]||t,c=t=>new Intl.NumberFormat("tr-TR",{style:"currency",currency:"TRY"}).format(t),B=t=>new Date(t).toLocaleDateString("tr-TR"),J=t=>new Date(t).toLocaleString("tr-TR"),Z=[{key:"beneficiaries",header:"İhtiyaç Sahibi",render:t=>{var a,s,n;return e.jsxs("div",{children:[e.jsxs("div",{className:"font-medium",children:[(a=t.beneficiaries)==null?void 0:a.name," ",(s=t.beneficiaries)==null?void 0:s.surname]}),e.jsx("div",{className:"text-sm text-muted-foreground",children:(n=t.beneficiaries)==null?void 0:n.category})]})}},{key:"amount",header:"Tutar",render:t=>e.jsx("div",{className:"font-medium text-green-600",children:c(t.amount)})},{key:"status",header:"Durum",render:t=>X(t.status)},{key:"approved_at",header:"Onay Tarihi",render:t=>B(t.approved_at)},{key:"distributed_at",header:"Dağıtım Tarihi",render:t=>t.distributed_at?B(t.distributed_at):"-"},{key:"payments",header:"Ödeme Yöntemi",render:t=>{var s;const a=(s=t.payments)==null?void 0:s[0];return a?G(a.payment_method):"-"}},{key:"notes",header:"Notlar",render:t=>e.jsx("div",{className:"max-w-xs truncate",title:t.notes,children:t.notes||"-"})},{key:"actions",header:"İşlemler",render:t=>e.jsxs("div",{className:"flex items-center gap-2",children:[t.status==="approved"&&e.jsx("button",{onClick:()=>{T(t),x(!0)},className:"rounded p-1 text-blue-600 hover:bg-blue-50",title:"Dağıt",children:e.jsx(I,{className:"h-4 w-4"})}),e.jsx("button",{className:"rounded p-1 text-gray-600 hover:bg-gray-50",title:"Detay",children:e.jsx(ue,{className:"h-4 w-4"})})]})}];return A?e.jsx("div",{className:"flex h-64 items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"h-8 w-8 animate-spin rounded-full border-4 border-primary border-t-transparent mx-auto mb-2"}),e.jsx("p",{className:"text-muted-foreground",children:"Yükleniyor..."})]})}):e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold",children:"Nakdi Yardım Veznesi"}),e.jsx("p",{className:"text-muted-foreground",children:"Nakdi yardımları yönetin ve dağıtın"})]})}),e.jsxs("div",{className:"grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-4",children:[e.jsx(v,{title:"Toplam Onaylanan",value:c(p.totalApproved),icon:e.jsx(N,{className:"h-5 w-5 text-green-700"}),accentClass:"bg-green-100"}),e.jsx(v,{title:"Toplam Dağıtılan",value:c(p.totalDistributed),icon:e.jsx(O,{className:"h-5 w-5 text-blue-700"}),accentClass:"bg-blue-100"}),e.jsx(v,{title:"Dağıtım Bekleyen",value:c(p.pendingDistribution),icon:e.jsx(le,{className:"h-5 w-5 text-orange-700"}),accentClass:"bg-orange-100"}),e.jsx(v,{title:"Bu Ay Toplam",value:c(p.monthlyTotal),icon:e.jsx(ie,{className:"h-5 w-5 text-purple-700"}),accentClass:"bg-purple-100"})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-4 rounded-lg border p-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ce,{className:"h-4 w-4 text-muted-foreground"}),e.jsx("input",{type:"text",placeholder:"Kayıt ara...",value:h,onChange:t=>V(t.target.value),className:"min-w-64 rounded border px-3 py-2 text-sm"})]}),e.jsxs("select",{value:b,onChange:t=>$(t.target.value),className:"rounded border px-3 py-2 text-sm",children:[e.jsx("option",{value:"all",children:"Tüm Durumlar"}),e.jsx("option",{value:"approved",children:"Onaylanan"}),e.jsx("option",{value:"distributed",children:"Dağıtılan"}),e.jsx("option",{value:"completed",children:"Tamamlanan"}),e.jsx("option",{value:"cancelled",children:"İptal Edilen"})]}),e.jsxs("select",{value:y,onChange:t=>z(t.target.value),className:"rounded border px-3 py-2 text-sm",children:[e.jsx("option",{value:"all",children:"Tüm Tarihler"}),e.jsx("option",{value:"today",children:"Bugün"}),e.jsx("option",{value:"week",children:"Bu Hafta"}),e.jsx("option",{value:"month",children:"Bu Ay"})]}),e.jsxs("button",{onClick:()=>ee("nakdi-yardim-kayitlari.csv",w),className:"flex items-center gap-2 rounded bg-green-600 px-3 py-2 text-sm text-white hover:bg-green-700",children:[e.jsx(de,{className:"h-4 w-4"}),"İndir"]}),e.jsxs("div",{className:"ml-auto text-sm text-muted-foreground",children:[w.length," kayıt"]})]}),e.jsx(te,{columns:Z,data:w}),e.jsxs(ae,{open:K,onClose:()=>x(!1),children:[e.jsxs("div",{className:"flex items-center justify-between border-b p-4",children:[e.jsx("h2",{className:"text-lg font-semibold",children:"Nakdi Yardım Dağıtımı"}),e.jsx("button",{onClick:()=>x(!1),className:"h-8 w-8 rounded-full bg-red-600 text-white hover:bg-red-700",children:"×"})]}),r&&e.jsxs("div",{className:"p-4 space-y-4",children:[e.jsxs("div",{className:"rounded border p-4 bg-gray-50",children:[e.jsx("h3",{className:"font-medium mb-2",children:"Yardım Detayları"}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("div",{children:[e.jsx("strong",{children:"İhtiyaç Sahibi:"})," ",(Y=r.beneficiaries)==null?void 0:Y.name," ",(E=r.beneficiaries)==null?void 0:E.surname]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Kategori:"})," ",(F=r.beneficiaries)==null?void 0:F.category]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Tutar:"})," ",c(r.amount)]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Onay Tarihi:"})," ",J(r.approved_at)]}),r.notes&&e.jsxs("div",{children:[e.jsx("strong",{children:"Notlar:"})," ",r.notes]})]})]}),e.jsxs("form",{onSubmit:P(U),className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Ödeme Yöntemi *"}),e.jsxs("select",{...g("payment_method"),className:"w-full rounded border px-3 py-2 text-sm",children:[e.jsx("option",{value:"",children:"Seçiniz..."}),e.jsx("option",{value:"cash",children:"Nakit"}),e.jsx("option",{value:"bank_transfer",children:"Banka Havalesi"}),e.jsx("option",{value:"check",children:"Çek"})]}),C.payment_method&&e.jsx("p",{className:"text-sm text-red-600 mt-1",children:C.payment_method.message})]}),k==="bank_transfer"&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Banka Hesap No"}),e.jsx("input",{type:"text",...g("bank_account"),className:"w-full rounded border px-3 py-2 text-sm",placeholder:"TR00 0000 0000 0000 0000 0000 00"})]}),(k==="bank_transfer"||k==="check")&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"İşlem Referansı"}),e.jsx("input",{type:"text",...g("transaction_ref"),className:"w-full rounded border px-3 py-2 text-sm",placeholder:"İşlem numarası veya referans kodu"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Notlar"}),e.jsx("textarea",{...g("notes"),rows:3,className:"w-full rounded border px-3 py-2 text-sm",placeholder:"Dağıtım ile ilgili notlar..."})]}),e.jsxs("div",{className:"flex justify-end gap-2 pt-4",children:[e.jsx("button",{type:"button",onClick:()=>x(!1),className:"rounded border px-4 py-2 text-sm hover:bg-gray-50",children:"İptal"}),e.jsxs("button",{type:"submit",className:"flex items-center gap-2 rounded bg-green-600 px-4 py-2 text-sm text-white hover:bg-green-700",children:[e.jsx(I,{className:"h-4 w-4"}),"Dağıt"]})]})]})]})]})]})}export{De as default};
